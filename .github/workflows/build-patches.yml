name: Build Voice-Over Translation Patches

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build patches with Gradle
      run: |
        ./gradlew clean build --no-daemon --stacktrace
        
    - name: Create patches bundle
      run: |
        # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è —Ä–µ–ª–∏–∑–∞
        mkdir -p release-bundle
        
        # –ö–æ–ø–∏—Ä—É–µ–º patches.json
        cp patches.json release-bundle/
        
        # –°–æ–∑–¥–∞–µ–º RVP —Ñ–∞–π–ª –∏–∑ build/libs
        cd build/libs
        if [ -f *.jar ]; then
          # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º JAR –≤ RVP
          cp *.jar ../../release-bundle/patches.rvp
        fi
        cd ../..
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ—Å—É—Ä—Å—ã
        if [ -d "patches/src/main/resources" ]; then
          cd patches/src/main/resources
          zip -r ../../../../release-bundle/patches.rvp . -u
          cd ../../../..
        fi
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: voice-over-patches
        path: release-bundle/
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release-bundle/patches.json
          release-bundle/patches.rvp
        draft: false
        prerelease: false
        name: "Voice-Over Translation Patches ${{ github.ref_name }}"
        body: |
          ## üéâ Voice-Over Translation Patches Release
          
          ### ‚ú® Features:
          - üéµ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≥–æ–ª–æ—Å–æ–≤–æ–π –ø–µ—Ä–µ–≤–æ–¥ –≤–∏–¥–µ–æ YouTube
          - ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –º–µ–Ω—é YouTube
          - üåç –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —è–∑—ã–∫–æ–≤
          - üîß –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ReVanced Manager
          
          ### üì± –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
          1. –°–∫–∞—á–∞–π—Ç–µ —Ñ–∞–π–ª—ã –∏–∑ —ç—Ç–æ–≥–æ —Ä–µ–ª–∏–∑–∞
          2. –î–æ–±–∞–≤—å—Ç–µ –≤ RVX Manager –∏—Å—Ç–æ—á–Ω–∏–∫:
             ```
             https://api.github.com/repos/${{ github.repository }}/releases/latest
             ```
          3. –°–æ–±–µ—Ä–∏—Ç–µ YouTube APK —Å –ø–∞—Ç—á–µ–º "Voice-Over Translation"
          
          ### üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:
          - **patches.json**: –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–∞—Ç—á–µ–π
          - **patches.rvp**: –°–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ç—á–∏ –∏ —Ä–µ—Å—É—Ä—Å—ã
          
          ### üéØ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:
          - YouTube –≤–µ—Ä—Å–∏–∏: 19.05.36, 19.16.39, 19.43.41, 19.44.39, 19.47.53, 20.30.35
          - –¢—Ä–µ–±—É–µ—Ç: RVX Manager –∏–ª–∏ ReVanced Manager
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 